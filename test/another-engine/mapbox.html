<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
    <title>MapBox Edit Properties 테스트</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet'/>
    <style>
        #map {
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            background-color: #EBEDEF;
            position: fixed;
        }
    </style>
</head>
</head>
<body>
<div class='section' id='wrap'>
    <h2>MapBox Edit Properties 테스트</span></h2>
    <div id='map'></div>
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoidHdpcGl4ZWwiLCJhIjoiY2pjeTdwZDV0MDR0bDJ2bHFncTI1c2FrdSJ9.IGpAPpo9nmEOrJgjjEIvEw';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v10',
    center: [127.10518200724181, 37.35885405128981],
    zoom: 19,
  });

  /**
   * 타입 분류
   * - 기둥 : pillar
   * - 회의실 : mettingroom
   * - 좌석 : seat
   * - 화장실(W) : toilet
   * - 화장실(M) : toilet
   * - 양치실 : lavatory
   * - 계단실 : stair
   * - 캐비넷(QA수납) : cabinet
   * - 1인 부스 : onebooth
   * - AD : ad
   * - AHU : ahu
   * - AV : av
   * - EPS : eps
   * - EV : ev
   * - PS : ps
   * - TPS : tps
   */

  const label = {
    pillar: '기둥',
    mettingroom: '회의실',
    seat: '좌석',
    toilet: '화장실',
    lavatory: '양치실',
    stair: '계단실',
    cabinet: '캐비넷(QA수납)',
    onebooth: '1인 부스',
    ad: 'ad',
    ahu: 'AHU',
    av: 'AV',
    eps: 'eps',
    ev: 'ev',
    ps: 'ps',
    tps: 'tps',
  };

  const lt = [127.10465294151231, 37.3593150852346],
    rt = [127.10570973186645, 37.3593150852346],
    rb = [127.10570973186645, 37.35846230345918],
    lb = [127.10465294151231, 37.35846230345918];

  map.on('load', () => {
    map.addSource('guide-markers', {
      type: 'geojson',
      data: {
        'type': 'FeatureCollection',
        'features': [
          {
            'type': 'Feature',
            'properties': {
              'label': 'lt',
            },
            'geometry': {
              'type': 'Point',
              'coordinates': lt
            }
          },
          {
            'type': 'Feature',
            'properties': {
              'label': 'rt',
            },
            'geometry': {
              'type': 'Point',
              'coordinates': rt
            }
          },
          {
            'type': 'Feature',
            'properties': {
              index: 2,
              'label': 'rb',
            },
            'geometry': {
              'type': 'Point',
              'coordinates': rb
            }
          },
          {
            'type': 'Feature',
            'properties': {
              'label': 'lb',
            },
            'geometry': {
              'type': 'Point',
              'coordinates': lb
            }
          }
        ]
      }
    });

    map.addSource('bg-image', {
      'type': 'image',
      'url': '../../data/data-greyfactory-9th-guide-bg.png',
      'coordinates': [lt, rt, rb, lb]
    });

    map.addLayer({
      id: 'bg-image',
      'type': 'raster',
      'source': 'bg-image',
      'paint': {
        'raster-fade-duration': 0
      }
    });

    const label = ['to-string', ['get', 'label']];
    const colors = ['#18AFD0', '#FD6368', '#FFB900', '#6967CE', '#FFFFFF'];

    map.addLayer({
      id: 'guide-markers',
      type: 'circle',
      source: 'guide-markers',
      paint: {
        'circle-color': [
          'case',
          ['==', label, 'lt'],
          colors[0],
          ['==', label, 'rt'],
          colors[1],
          ['==', label, 'rb'],
          colors[2],
          ['==', label, 'lb'],
          colors[3],
          colors[4]
        ],
        'circle-opacity': 0.6,
        'circle-radius': 14
      }
    });

    map.addLayer({
      'id': 'guide-markers-label',
      'type': 'symbol',
      'source': 'guide-markers',
      'layout': {
        'text-field': '{label}',
        'text-font': [
          'DIN Offc Pro Medium',
          'Arial Unicode MS Bold'
        ],
        'text-size': 18,
      },
      'paint': {
        'text-color': 'white'
      }
    });

    map.addSource('greyfactory', {
      type: 'geojson',
      data: '../../data/data-greyfactory-9th.geojson',
    });

    map.addLayer(
      {
        id: 'greyfactory',
        source: 'greyfactory',
        'type': 'fill',
        'paint': {
          'fill-color': 'rgba(200, 100, 240, 0.4)',
          'fill-outline-color': 'rgba(200, 100, 240, 1)'
        },
      },
    );

    map.on('click', (e) => {
      console.log(`[${e.lngLat.lng}, ${e.lngLat.lat}]`);
    });

    map.on('click', 'greyfactory', (e) => {
      const { name, type } = e.features[0]?.properties;
      const html =
        `<div>
            <input id="input-name" type="text" name="name" size="10" value="${name}">
            <button id="name-confirm" name="confirm" type="button">이름 입력</button>
            <br>
            <input id="input-type" type="text" name="type" size="10" value="${type}">
            <button id="type-confirm" name="confirm" type="button">타입 입력</button>
        </div>`;

      new mapboxgl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(html)
        .addTo(map);

      const nameButton = document.getElementById('name-confirm');
      const typeButton = document.getElementById('type-confirm');
      nameButton.addEventListener('click', () => {
        const name = document.getElementById('input-name').value || '';
        console.log(name);
      });

      typeButton.addEventListener('click', () => {
        const type = document.getElementById('input-type').value || '';
        console.log(type);
      })
    });

  });

</script>
</body>
</html>
